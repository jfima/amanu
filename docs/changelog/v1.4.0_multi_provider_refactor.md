# Multi-Provider Architecture Refactoring (v1.4.0-dev)

**Date:** 2025-11-27
**Status:** Completed

## Objective
Refactor the `amanu` application to support multiple transcription providers (Gemini, local Whisper, and Claude) in the `scribe` stage, allowing independent selection of providers for the `transcribe` and `refine` stages.

## Key Changes Implemented

### 1. Provider Architecture
*   **Abstract Base Classes**: Defined `TranscriptionProvider` and `RefinementProvider` in `amanu/core/providers.py`.
*   **Provider Factory**: Created `ProviderFactory` in `amanu/core/factory.py` to dynamically register and instantiate providers.
*   **Concrete Implementations**:
    *   **Gemini**: Full support for transcription and refinement (`amanu/plugins/gemini.py`).
    *   **Whisper**: Local transcription support via `whisper-cli` (`amanu/plugins/whisper.py`).
    *   **Claude**: Skeleton for transcription and placeholder for refinement (`amanu/plugins/claude.py`).

### 2. Configuration Refactoring
*   **New Structure**: Updated `config.yaml` to support top-level `transcribe` and `refine` blocks with `provider` and `model` keys.
*   **Provider Settings**: Added a `providers` block for provider-specific settings (API keys, model paths).
*   **Models**: Updated `amanu/core/models.py` and `amanu/core/config.py` to parse the new structure while maintaining backward compatibility.

### 3. Pipeline Updates
*   **IngestStage**: Now "provider-aware". It queries the selected transcription provider for `IngestSpecs` (target format, upload requirements) and prepares the audio accordingly (e.g., converts to WAV for Whisper, OGG for Gemini).
*   **ScribeStage**: Decoupled from Gemini. It uses `ProviderFactory` to get the selected `TranscriptionProvider` and delegates the transcription task.
*   **RefineStage**: Decoupled from Gemini. It uses `ProviderFactory` to get the selected `RefinementProvider` (currently only Gemini is fully implemented for refinement, but the architecture supports others).

### 4. Documentation
*   **Config Example**: Updated `config.example.yaml` with the new multi-provider configuration schema.
*   **Usage Guide**: Rewrote `docs/usage_guide.md` to explain how to configure and use the new providers.

## Verification
Verified the changes by running a test script that successfully loaded and instantiated the `GeminiProvider`, `WhisperProvider`, and `ClaudeProvider` using the new factory and configuration system.

## Next Steps
*   **Configure Whisper**: Users need to update `config.yaml` to point to local `whisper-cli` model paths under `providers.whisper.models`.
*   **Test Run**: Run jobs with mixed providers (e.g., `transcribe.provider: "whisper"` and `refine.provider: "gemini"`) to verify the hybrid pipeline.
